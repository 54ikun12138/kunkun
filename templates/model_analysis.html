{% extends "base.html" %}
{% block title %}æ¨¡å‹åˆ†æ | æ ¡å›­æ¶ˆè´¹åˆ†æç³»ç»Ÿ{% endblock %}
{% block extra_head %}
<script src="/static/echarts.min.js"></script>
<style>
  .model-section {
    margin-bottom: 2rem;
  }
  .section-title {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .stat-card {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(56, 189, 248, 0.15);
    border-radius: 14px;
    padding: 1.2rem;
    text-align: center;
  }
  .stat-card .label {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }
  .stat-card .value {
    font-size: 1.8rem;
    color: var(--accent);
    font-weight: 600;
  }
  .cluster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.2rem;
    margin-top: 1.5rem;
  }
  .cluster-card {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(56, 189, 248, 0.15);
    border-radius: 16px;
    padding: 1.5rem;
  }
  .cluster-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.8rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
  }
  .cluster-id {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--accent);
  }
  .cluster-count {
    color: var(--muted);
    font-size: 0.9rem;
  }
  .cluster-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.8rem;
    margin-bottom: 1rem;
  }
  .info-item {
    background: rgba(15, 23, 42, 0.6);
    padding: 0.6rem;
    border-radius: 8px;
  }
  .info-item .label {
    font-size: 0.8rem;
    color: var(--muted);
  }
  .info-item .value {
    font-size: 1rem;
    color: var(--text);
    margin-top: 0.2rem;
  }
  .student-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 1rem;
  }
  .student-item {
    padding: 0.5rem;
    background: rgba(15, 23, 42, 0.5);
    border-radius: 6px;
    margin-bottom: 0.4rem;
    font-size: 0.9rem;
    display: flex;
    justify-content: space-between;
  }
  .anomaly-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  .anomaly-table th,
  .anomaly-table td {
    padding: 0.8rem;
    text-align: left;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
  }
  .anomaly-table th {
    color: var(--muted);
    font-weight: 500;
    font-size: 0.9rem;
  }
  .anomaly-table tbody tr:hover {
    background: rgba(56, 189, 248, 0.08);
  }
  .anomaly-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  .anomaly-badge.anomaly {
    background: rgba(248, 113, 113, 0.2);
    color: #fca5a5;
    border: 1px solid rgba(248, 113, 113, 0.4);
  }
  .anomaly-badge.normal {
    background: rgba(74, 222, 128, 0.2);
    color: #86efac;
    border: 1px solid rgba(74, 222, 128, 0.4);
  }
  .score-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-family: monospace;
  }
  .score-low {
    background: rgba(248, 113, 113, 0.15);
    color: #fca5a5;
  }
  .score-medium {
    background: rgba(251, 191, 36, 0.15);
    color: #fde047;
  }
  .score-high {
    background: rgba(74, 222, 128, 0.15);
    color: #86efac;
  }
  .chart-container {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(56, 189, 248, 0.15);
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 1.5rem;
  }
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
  }
  .empty-state h3 {
    color: var(--text);
    margin-bottom: 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
{% if not has_data %}
<div class="panel">
  <div class="empty-state">
    <h3>æš‚æ— æ•°æ®</h3>
    <p>è¯·å…ˆä¸Šä¼ æ¶ˆè´¹æ•°æ®ä»¥è¿›è¡Œæ¨¡å‹åˆ†æ</p>
    <a href="{% url 'MyApp:upload_csv' %}" class="btn btn-primary" style="margin-top: 1rem;">ä¸Šä¼ æ•°æ®</a>
  </div>
</div>
{% else %}
<!-- ç»Ÿè®¡æ¦‚è§ˆ -->
<div class="panel">
  <div class="section-title">
    <span>ğŸ“Š</span>
    <span>åˆ†ææ¦‚è§ˆ</span>
  </div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="label">æ€»å­¦ç”Ÿæ•°</div>
      <div class="value">{{ total_students }}</div>
    </div>
    <div class="stat-card">
      <div class="label">èšç±»æ•°é‡</div>
      <div class="value">{{ cluster_results|length }}</div>
    </div>
    <div class="stat-card">
      <div class="label">å¼‚å¸¸å­¦ç”Ÿ</div>
      <div class="value" style="color: var(--danger);">{{ anomaly_stats.anomaly_count }}</div>
    </div>
    <div class="stat-card">
      <div class="label">å¼‚å¸¸æ¯”ä¾‹</div>
      <div class="value">{{ anomaly_stats.anomaly_ratio|floatformat:1 }}%</div>
    </div>
  </div>
</div>

<!-- èšç±»åˆ†å¸ƒå›¾ -->
<div class="panel">
  <div class="section-title">
    <span>ğŸ¯</span>
    <span>K-Means èšç±»åˆ†æ</span>
  </div>
  <div class="chart-container">
    <div id="clusterChart" style="height: 300px;"></div>
  </div>
  
  <div class="cluster-grid">
    {% for cluster in cluster_results %}
    <div class="cluster-card">
      <div class="cluster-header">
        <span class="cluster-id">èšç±» {{ cluster.cluster_id|add:1 }}</span>
        <span class="cluster-count">{{ cluster.student_count }} åå­¦ç”Ÿ</span>
      </div>
      <div class="cluster-info">
        <div class="info-item">
          <div class="label">å¹³å‡æ€»æ¶ˆè´¹</div>
          <div class="value">Â¥ {{ cluster.avg_total_amount|floatformat:2 }}</div>
        </div>
        <div class="info-item">
          <div class="label">å¹³å‡æ¶ˆè´¹æ¬¡æ•°</div>
          <div class="value">{{ cluster.avg_transaction_count|floatformat:1 }} æ¬¡</div>
        </div>
      </div>
      <div style="margin-top: 1rem;">
        <div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.5rem;">
          å­¦ç”Ÿåˆ—è¡¨ (æ˜¾ç¤ºå‰ {{ cluster.students|length }} åï¼Œå…± {{ cluster.total_students }} å)
        </div>
        <div class="student-list">
          {% for student_no in cluster.students %}
          <div class="student-item">
            <span>{{ student_no }}</span>
            <span style="color: var(--muted); font-size: 0.85rem;">
              {% for item in cluster.cluster_data %}
                {% if item.student_no == student_no %}
                  Â¥{{ item.total_amount|floatformat:2 }} Â· {{ item.transaction_count }}æ¬¡
                {% endif %}
              {% endfor %}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- å¼‚å¸¸æ£€æµ‹ -->
<div class="panel">
  <div class="section-title">
    <span>ğŸ”</span>
    <span>å­¤ç«‹æ£®æ—å¼‚å¸¸æ£€æµ‹</span>
  </div>
  <p style="color: var(--muted); margin-bottom: 1rem;">
    ä½¿ç”¨å­¤ç«‹æ£®æ—ç®—æ³•æ£€æµ‹æ¶ˆè´¹è¡Œä¸ºå¼‚å¸¸çš„å­¦ç”Ÿã€‚å¼‚å¸¸åˆ†æ•°è¶Šä½ï¼Œè¡¨ç¤ºè¯¥å­¦ç”Ÿçš„æ¶ˆè´¹è¡Œä¸ºè¶Šå¼‚å¸¸ã€‚
  </p>
  
  {% if anomaly_results %}
  <div style="margin-top: 1.5rem;">
    <h3 style="color: var(--danger); margin-bottom: 1rem;">å¼‚å¸¸å­¦ç”Ÿåˆ—è¡¨ (å…± {{ anomaly_results|length }} å)</h3>
    <div style="overflow-x: auto;">
      <table class="anomaly-table">
        <thead>
          <tr>
            <th>å­¦å·</th>
            <th>æ€»æ¶ˆè´¹é‡‘é¢</th>
            <th>å¹³å‡æ¶ˆè´¹</th>
            <th>æœ€å¤§å•ç¬”</th>
            <th>æ¶ˆè´¹æ¬¡æ•°</th>
            <th>å•†æˆ·å¤šæ ·æ€§</th>
            <th>å·¥ä½œæ—¥æ¯”ä¾‹</th>
            <th>å¼‚å¸¸åˆ†æ•°</th>
            <th>æ‰€å±èšç±»</th>
          </tr>
        </thead>
        <tbody>
          {% for item in anomaly_results %}
          <tr>
            <td><strong>{{ item.student_no }}</strong></td>
            <td>Â¥ {{ item.total_amount|floatformat:2 }}</td>
            <td>Â¥ {{ item.avg_amount|floatformat:2 }}</td>
            <td>Â¥ {{ item.max_amount|floatformat:2 }}</td>
            <td>{{ item.transaction_count }}</td>
            <td>{{ item.merchant_diversity }}</td>
            <td>{{ item.weekday_ratio|floatformat:1 }}%</td>
            <td>
              <span class="score-badge score-low">
                {{ item.anomaly_score|floatformat:3 }}
              </span>
            </td>
            <td>èšç±» {{ item.cluster|add:1 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="empty-state" style="padding: 2rem;">
    <p>æœªæ£€æµ‹åˆ°å¼‚å¸¸å­¦ç”Ÿ</p>
  </div>
  {% endif %}
  
  {% if normal_results %}
  <div style="margin-top: 2rem;">
    <h3 style="color: var(--success); margin-bottom: 1rem;">æ­£å¸¸å­¦ç”Ÿæ ·æœ¬ (æ˜¾ç¤ºå‰ {{ normal_results|length }} å)</h3>
    <div style="overflow-x: auto;">
      <table class="anomaly-table">
        <thead>
          <tr>
            <th>å­¦å·</th>
            <th>æ€»æ¶ˆè´¹é‡‘é¢</th>
            <th>å¹³å‡æ¶ˆè´¹</th>
            <th>æ¶ˆè´¹æ¬¡æ•°</th>
            <th>å¼‚å¸¸åˆ†æ•°</th>
            <th>æ‰€å±èšç±»</th>
          </tr>
        </thead>
        <tbody>
          {% for item in normal_results %}
          <tr>
            <td><strong>{{ item.student_no }}</strong></td>
            <td>Â¥ {{ item.total_amount|floatformat:2 }}</td>
            <td>Â¥ {{ item.avg_amount|floatformat:2 }}</td>
            <td>{{ item.transaction_count }}</td>
            <td>
              <span class="score-badge score-high">
                {{ item.anomaly_score|floatformat:3 }}
              </span>
            </td>
            <td>èšç±» {{ item.cluster|add:1 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>

<!-- ç‰¹å¾è¯´æ˜ -->
<div class="panel">
  <div class="section-title">
    <span>ğŸ“‹</span>
    <span>ç‰¹å¾è¯´æ˜</span>
  </div>
  <p style="color: var(--muted); margin-bottom: 1rem;">
    æ¨¡å‹ä½¿ç”¨äº†ä»¥ä¸‹8ä¸ªç‰¹å¾å¯¹å­¦ç”Ÿæ¶ˆè´¹è¡Œä¸ºè¿›è¡Œåˆ†æï¼š
  </p>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
    {% for feature_name in feature_names %}
    <div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 10px; border-left: 3px solid var(--accent);">
      <strong style="color: var(--accent);">{{ forloop.counter }}.</strong>
      <span style="color: var(--text);">{{ feature_name }}</span>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  // èšç±»åˆ†å¸ƒå›¾
  const clusterData = JSON.parse('{{ cluster_distribution|escapejs }}');

  const chart = echarts.init(document.getElementById('clusterChart'), null, { useDirtyRect: true });
  chart.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c} åå­¦ç”Ÿ ({d}%)'
    },
    legend: {
      bottom: 10,
      textStyle: { color: '#94a3b8' }
    },
    series: [{
      name: 'èšç±»åˆ†å¸ƒ',
      type: 'pie',
      radius: ['40%', '70%'],
      avoidLabelOverlap: false,
      itemStyle: {
        borderRadius: 10,
        borderColor: '#0f172a',
        borderWidth: 2
      },
      label: {
        show: true,
        formatter: '{b}\n{c}äºº ({d}%)',
        color: '#e2e8f0'
      },
      emphasis: {
        label: {
          show: true,
          fontSize: 14,
          fontWeight: 'bold'
        }
      },
      data: clusterData.labels.map((label, idx) => ({
        value: clusterData.counts[idx],
        name: label
      }))
    }],
    textStyle: { color: '#e2e8f0' }
  });
  
  window.addEventListener('resize', () => chart.resize());
</script>
{% endif %}
{% endblock %}

